<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>F1 Manager ‚Äî Race View (Demo)</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <style>
            body {
                background: #0b1220;
                color: #e6eef8;
            }
            .card {
                background: rgba(255, 255, 255, 0.04);
                border: 1px solid rgba(255, 255, 255, 0.06);
            }
            .driver-row {
                transition: transform 0.15s;
            }
            .driver-name {
                font-weight: 600;
            }
            .small-muted {
                font-size: 0.85rem;
            }
            .pos-badge {
                min-width: 40px;
            }
        </style>
    </head>
    <body>
        <div class="container py-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">üèÅ F1 Manager ‚Äî Race View (Demo)</h3>
                <div>
                    <div class="btn-group me-2" role="group" aria-label="speed">
                        <button
                            id="speed1"
                            class="btn btn-outline-light active"
                        >
                            1x (5s/lap)
                        </button>
                        <button id="speed2" class="btn btn-outline-light">
                            2x (4s/lap)
                        </button>
                        <button id="speed3" class="btn btn-outline-light">
                            3x (2s/lap)
                        </button>
                    </div>
                    <button id="pauseBtn" class="btn btn-warning">Pause</button>
                    <button id="resetBtn" class="btn btn-danger">Reset</button>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-lg-7">
                    <div class="card p-3">
                        <div
                            class="d-flex justify-content-between align-items-center mb-2"
                        >
                            <div>
                                <div class="small-muted">Lap</div>
                                <h4 id="lapInfo" class="mb-0">1 / 25</h4>
                            </div>
                            <div class="text-end">
                                <div class="small-muted">Race Time</div>
                                <h4 id="raceClock" class="mb-0">00:00.000</h4>
                            </div>
                        </div>

                        <div id="driversList" class="list-group mt-3">
                            <!-- driver rows injected here -->
                        </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="card p-3">
                        <h5 class="mb-3">Leaderboard (realtime)</h5>
                        <div id="leaderboard" class="list-group">
                            <!-- leaderboard rows -->
                        </div>
                        <hr class="my-3" />
                        <div>
                            <h6>Race Controls & Info</h6>
                            <p class="small-muted mb-1">
                                Kecepatan lap:
                                <span id="speedInfo">1x = 5s/lap</span>
                            </p>
                            <p class="small-muted">
                                Setiap lap punya sedikit variasi acak ¬±10% untuk
                                realism.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="mt-3 small-muted">
                Demo ringan ‚Äî buat prototipe UI race. Enjoy the chaos. üöÄ
            </footer>
        </div>

        <script>
            /*
  Simple F1 race simulation for UI:
  - N pembalap
  - Race length: lapsTotal
  - Three global speed multipliers mapped to seconds per lap:
      1x => 5s / lap
      2x => 4s / lap
      3x => 2s / lap
  - Each driver has a pace stat; actual lap time = baseLapSeconds / paceModifier + randomVariance
  - Leaderboard sorted by (lapsCompleted desc, totalTime asc)
  - Realtime updates using setInterval; progress shown as fraction and progressbar
*/

            // === CONFIG ===
            const lapsTotal = 25;
            const baseLapBySpeed = { 1: 5.0, 2: 4.0, 3: 2.0 }; // seconds per lap at each speed
            let currentSpeedKey = "1";
            let isRunning = true;

            // Example drivers (name, pace (higher = faster))
            const drivers = [
                { id: 1, name: "Verstappen", pace: 1.05 },
                { id: 2, name: "Leclerc", pace: 1.02 },
                { id: 3, name: "Russell", pace: 1.01 },
                { id: 4, name: "Hamilton", pace: 1.0 },
                { id: 5, name: "Perez", pace: 0.98 },
                { id: 6, name: "Sainz", pace: 0.97 },
                { id: 7, name: "Norris", pace: 0.96 },
                { id: 8, name: "Alonso", pace: 0.95 },
                { id: 9, name: "Ocon", pace: 0.93 },
                { id: 10, name: "Gasly", pace: 0.92 },
            ];

            // Runtime state per driver
            drivers.forEach((d) => {
                d.lapsCompleted = 0;
                d.currentLapProgress = 0; // 0..1
                d.totalTime = 0; // seconds
                d.lastLapTime = 0;
            });

            // DOM refs
            const driversList = document.getElementById("driversList");
            const leaderboard = document.getElementById("leaderboard");
            const lapInfo = document.getElementById("lapInfo");
            const raceClock = document.getElementById("raceClock");
            const speedInfo = document.getElementById("speedInfo");
            const pauseBtn = document.getElementById("pauseBtn");
            const resetBtn = document.getElementById("resetBtn");

            // Buttons
            document
                .getElementById("speed1")
                .addEventListener("click", () => setSpeed("1"));
            document
                .getElementById("speed2")
                .addEventListener("click", () => setSpeed("2"));
            document
                .getElementById("speed3")
                .addEventListener("click", () => setSpeed("3"));
            pauseBtn.addEventListener("click", togglePause);
            resetBtn.addEventListener("click", resetRace);

            // create UI rows
            function createDriverRow(driver) {
                const el = document.createElement("div");
                el.className =
                    "list-group-item driver-row d-flex align-items-center gap-3";
                el.id = "driver-" + driver.id;
                el.innerHTML = `
    <div class="d-flex align-items-center flex-grow-1">
      <div class="me-3">
        <span class="badge bg-dark text-light pos-badge" id="pos-${
            driver.id
        }">--</span>
      </div>
      <div class="flex-grow-1">
        <div class="d-flex justify-content-between">
          <div>
            <div class="driver-name">${driver.name}</div>
            <div class="small-muted">Pace: ${driver.pace.toFixed(2)}</div>
          </div>
          <div class="text-end">
            <div class="small-muted">Laps</div>
            <div id="laps-${driver.id}">0 / ${lapsTotal}</div>
          </div>
        </div>
        <div class="progress mt-2" style="height:8px">
          <div id="prog-${
              driver.id
          }" class="progress-bar" role="progressbar" style="width:0%"></div>
        </div>
        <div class="d-flex justify-content-between small-muted mt-1">
          <div id="lastLap-${driver.id}">Last: --</div>
          <div id="totalTime-${driver.id}">Total: 0.000s</div>
        </div>
      </div>
    </div>
  `;
                driversList.appendChild(el);
            }

            // populate
            drivers.forEach(createDriverRow);

            // UTILS
            function secToClock(t) {
                const ms = Math.floor((t - Math.floor(t)) * 1000);
                const s = Math.floor(t % 60);
                const m = Math.floor((t / 60) % 60);
                const mm = m.toString().padStart(2, "0");
                const ss = s.toString().padStart(2, "0");
                const mss = ms.toString().padStart(3, "0");
                return `${mm}:${ss}.${mss}`;
            }

            // Race-wide variables
            let raceElapsed = 0; // seconds
            let lastTick = performance.now();

            // The main tick runs fairly fast (every 50ms) to animate progress smoothly
            const TICK_MS = 50;

            // compute expected lap duration for driver at current speed (seconds)
            function expectedLapSeconds(driver) {
                const base = baseLapBySpeed[currentSpeedKey];
                // driver.pace is multiplier around 1.0 (bigger = faster). To convert: faster => smaller time.
                // We'll invert it so higher pace lowers lap time.
                const paceFactor = 1 / driver.pace;
                return base * paceFactor;
            }

            // simulate one tick
            function tick() {
                if (!isRunning) {
                    lastTick = performance.now();
                    return;
                }
                const now = performance.now();
                const dt = (now - lastTick) / 1000; // seconds since last tick
                lastTick = now;
                raceElapsed += dt;

                // update each driver
                drivers.forEach((d) => {
                    // If driver already finished all laps, nothing to progress
                    if (d.lapsCompleted >= lapsTotal) {
                        d.currentLapProgress = 1;
                        return;
                    }
                    // expected lap seconds for this driver (can change if speed changed mid-race)
                    const lapSec = expectedLapSeconds(d);
                    // add some small per-lap random variation: we'll not re-roll every tick; simulate by small noise per lap start
                    if (
                        !d._currentLapTarget ||
                        d._currentLapTargetBase !== lapSec
                    ) {
                        // start of a new lap or speed changed
                        const variance = (Math.random() * 0.9 - 0.1) * lapSec; // ¬±10%
                        d._currentLapTarget = Math.max(0.5, lapSec + variance);
                        d._currentLapTargetBase = lapSec;
                        d._currentLapProgress = d.currentLapProgress || 0;
                        d._currentLapElapsed =
                            d._currentLapProgress * d._currentLapTarget;
                    }
                    // progress
                    d._currentLapElapsed += dt;
                    d.currentLapProgress = Math.min(
                        1,
                        d._currentLapElapsed / d._currentLapTarget
                    );

                    // complete lap
                    if (d.currentLapProgress >= 1 - 1e-9) {
                        const lapTime = d._currentLapTarget;
                        d.lapsCompleted += 1;
                        d.lastLapTime = lapTime;
                        d.totalTime += lapTime;
                        // reset progress for next lap
                        d.currentLapProgress = 0;
                        d._currentLapTarget = null;
                        d._currentLapElapsed = 0;
                    }
                });

                // update UI
                updateUI();
                // check race end
                const finishedCount = drivers.filter(
                    (d) => d.lapsCompleted >= lapsTotal
                ).length;
                if (finishedCount === drivers.length) {
                    isRunning = false;
                    pauseBtn.textContent = "Race Finished";
                    pauseBtn.classList.remove("btn-warning");
                    pauseBtn.classList.add("btn-success");
                }
            }

            // sort and update UI elements
            function updateUI() {
                // compute global lap number to display: max laps completed among drivers + 1 (if race ongoing) capped
                const maxLapFinished = Math.max(
                    ...drivers.map((d) => d.lapsCompleted)
                );
                const displayLap = Math.min(
                    lapsTotal,
                    maxLapFinished + (isRunning ? 1 : 0)
                );
                lapInfo.textContent = `${displayLap} / ${lapsTotal}`;

                // race clock
                raceClock.textContent = secToClock(raceElapsed);

                // Leaderboard: sort by laps desc then totalTime asc; drivers still on same lap compare partial progress (higher progress is ahead)
                const ranking = drivers.slice().sort((a, b) => {
                    if (a.lapsCompleted !== b.lapsCompleted)
                        return b.lapsCompleted - a.lapsCompleted;
                    // same completed laps: whoever has larger currentLapProgress is ahead
                    if (a.currentLapProgress !== b.currentLapProgress)
                        return b.currentLapProgress - a.currentLapProgress;
                    // fallback: totalTime ascending
                    return a.totalTime - b.totalTime;
                });

                // update position badges in driver list and progressbars
                ranking.forEach((d, idx) => {
                    const posEl = document.getElementById("pos-" + d.id);
                    if (posEl) posEl.textContent = idx + 1;
                });

                // update each driver's UI block
                drivers.forEach((d) => {
                    const prog = document.getElementById("prog-" + d.id);
                    const lapsEl = document.getElementById("laps-" + d.id);
                    const lastLapEl = document.getElementById(
                        "lastLap-" + d.id
                    );
                    const totalTimeEl = document.getElementById(
                        "totalTime-" + d.id
                    );
                    if (prog)
                        prog.style.width = d.currentLapProgress * 100 + "%";
                    if (lapsEl)
                        lapsEl.textContent = `${d.lapsCompleted} / ${lapsTotal}`;
                    if (lastLapEl)
                        lastLapEl.textContent = d.lastLapTime
                            ? `Last: ${d.lastLapTime.toFixed(3)}s`
                            : "Last: --";
                    if (totalTimeEl)
                        totalTimeEl.textContent = `Total: ${d.totalTime.toFixed(
                            3
                        )}s`;
                });

                // rebuild leaderboard DOM (compact)
                leaderboard.innerHTML = "";
                ranking.forEach((d, i) => {
                    const li = document.createElement("div");
                    li.className =
                        "list-group-item d-flex justify-content-between align-items-center";
                    li.innerHTML = `
      <div>
        <strong>#${i + 1} ${d.name}</strong>
        <div class="small-muted">Laps: ${d.lapsCompleted}/${lapsTotal} ¬∑ ${
                        d.currentLapProgress > 0
                            ? "Progress: " +
                              Math.floor(d.currentLapProgress * 100) +
                              "%"
                            : ""
                    }</div>
      </div>
      <div class="text-end small-muted">
        <div>${d.totalTime.toFixed(3)}s</div>
        <div>${d.lastLapTime ? d.lastLapTime.toFixed(3) + "s" : "--"}</div>
      </div>
    `;
                    leaderboard.appendChild(li);
                });
            }

            // Speed control
            function setSpeed(k) {
                currentSpeedKey = k;
                // update button active classes
                document
                    .getElementById("speed1")
                    .classList.toggle("active", k === "1");
                document
                    .getElementById("speed2")
                    .classList.toggle("active", k === "2");
                document
                    .getElementById("speed3")
                    .classList.toggle("active", k === "3");
                speedInfo.textContent = `${k}x = ${baseLapBySpeed[k]}s/lap (base)`;
                // Note: new speed affects expected lap seconds for next lap (we handle by checking lap base)
            }

            // Pause / resume
            function togglePause() {
                isRunning = !isRunning;
                pauseBtn.textContent = isRunning ? "Pause" : "Resume";
                pauseBtn.classList.toggle("btn-warning", isRunning);
                pauseBtn.classList.toggle("btn-success", !isRunning);
                lastTick = performance.now();
            }

            // Reset race
            function resetRace() {
                // reset state
                raceElapsed = 0;
                lastTick = performance.now();
                drivers.forEach((d) => {
                    d.lapsCompleted = 0;
                    d.currentLapProgress = 0;
                    d.totalTime = 0;
                    d.lastLapTime = 0;
                    d._currentLapTarget = null;
                    d._currentLapElapsed = 0;
                });
                isRunning = true;
                pauseBtn.textContent = "Pause";
                pauseBtn.classList.remove("btn-success");
                pauseBtn.classList.add("btn-warning");
                updateUI();
            }

            // Initial UI update
            updateUI();

            // start ticking
            setInterval(tick, TICK_MS);
        </script>
    </body>
</html>
