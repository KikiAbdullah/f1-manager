<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Mini Racing Game with Laps & AI Strategy</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background: #111;
                color: #eee;
                text-align: center;
                margin: 0;
                padding: 0;
            }
            canvas {
                background: #333;
                display: block;
                margin: 20px auto;
                border: 2px solid #fff;
            }
            .controls {
                margin: 10px;
            }
            .driver-controls {
                margin: 10px auto;
                display: flex;
                justify-content: center;
                gap: 20px;
                flex-wrap: wrap;
            }
            .hud {
                margin: 20px auto;
                width: 90%;
                max-width: 900px;
                background: #222;
                padding: 10px;
                border-radius: 10px;
                text-align: left;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }
            th,
            td {
                border: 1px solid #444;
                padding: 5px;
                text-align: center;
                font-size: 0.9em;
            }
            th {
                background: #555;
            }
        </style>
    </head>
    <body>
        <h1>üèÅ Mini Racing Game üèÅ</h1>
        <div class="controls">
            <button onclick="startRace()">Start</button>
            <button onclick="togglePause()">Pause/Resume</button>
            <button onclick="resetRace()">Reset</button>
            <label
                >Laps:
                <input
                    id="lapsInput"
                    type="number"
                    value="3"
                    min="1"
                    style="width: 50px"
            /></label>
        </div>

        <div class="driver-controls" id="driverControls"></div>

        <canvas id="raceCanvas" width="1000" height="500"></canvas>

        <div class="hud">
            <h3>Standings</h3>
            <table id="standings">
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Driver</th>
                        <th>Lap</th>
                        <th>Last Lap</th>
                        <th>Best Lap</th>
                        <th>Sector 1</th>
                        <th>Sector 2</th>
                        <th>Sector 3</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <script>
            // ambil canvas dan context untuk menggambar
            const canvas = document.getElementById("raceCanvas");
            const ctx = canvas.getContext("2d");

            // variabel global
            let drivers = []; // data semua pembalap
            let raceInterval; // interval race loop
            let paused = false; // status pause
            let totalLaps = 3; // jumlah lap
            let raceStartTime; // waktu start race

            const raceLength = 700; // panjang track (1 lap) dalam pixel

            // inisialisasi pembalap
            function createDrivers() {
                drivers = [
                    { name: "YOU", color: "#4caf50", isPlayer: true }, // player 1
                    { name: "YOU-1", color: "#f44336", isPlayer: true }, // player 2
                    { name: "AI-2", color: "#2196f3" }, // AI lawan 1
                    { name: "AI-3", color: "#ff9800" }, // AI lawan 2
                    { name: "AI-4", color: "#9c27b0" }, // AI lawan 3
                    { name: "AI-5", color: "#795548" }, // AI lawan 4
                    { name: "AI-6", color: "#e91e63" }, // AI lawan 5
                    { name: "AI-7", color: "#00bcd4" }, // AI lawan 6
                    { name: "AI-8", color: "#cddc39" }, // AI lawan 7
                    { name: "AI-9", color: "#607d8b" }, // AI lawan 8
                ].map((d, i) => ({
                    ...d,
                    x: 0, // posisi horizontal (progress race)
                    y: 60 * (i + 1), // posisi vertical (track lane)
                    mode: "normal", // strategi awal
                    currentLap: 1, // lap sekarang
                    laps: [], // kumpulan laptime
                    bestLap: null, // lap tercepat
                    sectorTimes: [], // waktu sektor (S1, S2, S3)
                    lastLap: null, // laptime terakhir
                    finished: false, // sudah selesai race atau belum
                    lastUpdate: null, // waktu update terakhir
                }));
            }

            // memulai race
            function startRace() {
                resetRace(); // reset dulu kondisi
                totalLaps =
                    parseInt(document.getElementById("lapsInput").value) || 3; // ambil input lap
                raceStartTime = performance.now(); // catat waktu start
                raceInterval = setInterval(updateRace, 50); // jalankan loop update setiap 50ms

                // ubah mode AI setiap 3 detik (random)
                setInterval(() => {
                    drivers.forEach((d) => {
                        if (!d.isPlayer && !d.finished) {
                            const modes = ["aggressive", "normal", "slowdown"];
                            d.mode =
                                modes[Math.floor(Math.random() * modes.length)];
                        }
                    });
                }, 5000);
            }

            // pause / resume
            function togglePause() {
                paused = !paused;
            }

            // reset kondisi race
            function resetRace() {
                clearInterval(raceInterval); // stop interval sebelumnya
                createDrivers(); // bikin ulang pembalap
                renderControls(); // render kontrol untuk player
                updateStandings(); // update tabel standings
                drawTrack(); // gambar track & mobil
            }

            // render dropdown kontrol untuk player
            function renderControls() {
                const container = document.getElementById("driverControls");
                container.innerHTML = "";
                drivers.forEach((d, i) => {
                    if (d.isPlayer) {
                        const div = document.createElement("div");
                        // dropdown ganti mode
                        div.innerHTML = `<b>${d.name}</b>: 
                          <select onchange="drivers[${i}].mode=this.value">
                            <option value="aggressive">Aggressive</option>
                            <option value="normal" selected>Normal</option>
                            <option value="slowdown">Slowdown</option>
                          </select>`;
                        container.appendChild(div);
                    }
                });
            }

            // update posisi pembalap
            function updateRace() {
                if (paused) return; // kalau pause, stop update
                const now = performance.now();

                drivers.forEach((d) => {
                    if (d.finished) return; // skip kalau sudah finish

                    // tentukan kecepatan dasar berdasarkan mode
                    let baseSpeed = 5;
                    if (d.mode === "aggressive")
                        baseSpeed = 7 + Math.random() * 2;
                    if (d.mode === "slowdown")
                        baseSpeed = 3 + Math.random() * 1;

                    // tambah posisi sesuai kecepatan
                    d.x += baseSpeed;

                    // hitung posisi relatif dalam lap
                    const lapPos = d.x % raceLength;
                    const totalProgress =
                        (d.currentLap - 1) * raceLength + lapPos;

                    // hitung delta waktu antar update
                    if (!d.lastUpdate) d.lastUpdate = now;
                    const delta = (now - d.lastUpdate) / 1000;
                    d.lastUpdate = now;

                    // cek sektor (1/3 & 2/3)
                    if (
                        lapPos >= raceLength / 3 &&
                        d.sectorTimes.length % 3 === 0
                    ) {
                        d.sectorTimes.push(delta); // sector 1 selesai
                    } else if (
                        lapPos >= (2 * raceLength) / 3 &&
                        d.sectorTimes.length % 3 === 1
                    ) {
                        d.sectorTimes.push(delta); // sector 2 selesai
                    }

                    // kalau sudah melewati 1 lap
                    if (d.x >= d.currentLap * raceLength) {
                        const lapTime =
                            (now -
                                (raceStartTime +
                                    d.laps.reduce((a, b) => a + b, 0) * 1000)) /
                            1000;

                        d.laps.push(lapTime); // simpan waktu lap
                        d.lastLap = lapTime.toFixed(2); // simpan lap terakhir
                        if (!d.bestLap || lapTime < d.bestLap)
                            d.bestLap = lapTime.toFixed(2); // update best lap

                        // cek apakah sudah selesai semua lap
                        if (d.currentLap >= totalLaps) {
                            d.finished = true;
                        } else {
                            d.currentLap++;
                        }
                    }
                });

                // render ulang track dan standings
                drawTrack();
                updateStandings();
            }

            // gambar track dan pembalap
            function drawTrack() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // gambar garis track
                ctx.strokeStyle = "#fff";
                ctx.beginPath();
                ctx.moveTo(50, 30);
                ctx.lineTo(raceLength + 50, 30);
                ctx.stroke();

                // gambar tiap pembalap sebagai lingkaran
                drivers.forEach((d) => {
                    ctx.beginPath();
                    ctx.fillStyle = d.color;
                    ctx.arc(50 + (d.x % raceLength), d.y, 15, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = "#fff";
                    ctx.font = "12px Arial";
                    ctx.fillText(d.name, 40 + (d.x % raceLength), d.y + 4);
                });
            }

            // update tabel standings
            function updateStandings() {
                const tbody = document.querySelector("#standings tbody");
                tbody.innerHTML = "";

                // urutkan berdasarkan progress
                const sorted = [...drivers].sort((a, b) => {
                    if (a.finished && !b.finished) return 1;
                    if (!a.finished && b.finished) return -1;
                    if (a.currentLap !== b.currentLap)
                        return b.currentLap - a.currentLap;
                    return (b.x % raceLength) - (a.x % raceLength);
                });

                // render tabel
                sorted.forEach((d, i) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                      <td>${i + 1}</td>
                      <td>${d.name}</td>
                      <td>${d.currentLap}/${totalLaps}</td>
                      <td>${d.lastLap || "-"}</td>
                      <td>${d.bestLap || "-"}</td>
                      <td>${
                          d.sectorTimes[d.sectorTimes.length - 3]?.toFixed(2) ||
                          "-"
                      }</td>
                      <td>${
                          d.sectorTimes[d.sectorTimes.length - 2]?.toFixed(2) ||
                          "-"
                      }</td>
                      <td>${
                          d.sectorTimes[d.sectorTimes.length - 1]?.toFixed(2) ||
                          "-"
                      }</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // jalankan reset awal
            resetRace();
        </script>
    </body>
</html>
